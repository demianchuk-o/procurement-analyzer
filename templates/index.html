{% extends 'base.html' %} {% block title %}Головна{% endblock %} {% block
content %}

<div id="polling-status" class="my-3"></div>

<div class="pagination justify-content-center">
  <ul class="pagination">
    {% if page > 1 %}
    <li class="page-item">
      <a class="page-link" href="{{ url_for('index', page=page-1) }}"
        >Попередня</a
      >
    </li>
    {% endif %} {% for page_num in range(1, (total // per_page) + 2) %}
    <li class="page-item {% if page == page_num %}active{% endif %}">
      <a class="page-link" href="{{ url_for('index', page=page_num) }}"
        >{{ page_num }}</a
      >
    </li>
    {% endfor %} {% if page < (total // per_page) + 1 %}
    <li class="page-item">
      <a class="page-link" href="{{ url_for('index', page=page+1) }}"
        >Наступна</a
      >
    </li>
    {% endif %}
  </ul>
</div>

<div class="row">
  {% for tender in tenders %}
  <div class="col-md-4 tender-card">
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">
          {{ tender.title[:50] }}{% if tender.title|length > 50 %}...{% endif %}
        </h5>
        <p class="card-text">
          <small class="text-muted"
            >Дата: {{ format_datetime(tender.date_modified) }}</small
          >
        </p>
        <a
          href="{{ url_for('tender.tender_detail', tender_id=tender.tender_id) }}"
          class="btn btn-primary"
          >Деталі</a
        >
      </div>
    </div>
  </div>
  {% else %} {% if ocid_being_added and not tenders %}
  <div class="col-12">
    <p>
      Тендер з OCID <strong>{{ ocid_being_added }}</strong> ще обробляється або
      не знайдено. Зачекайте...
    </p>
  </div>
  {% elif title_filter and not tenders %}
  <div class="col-12">
    <p>Не знайдено тендерів за вашим запитом "{{title_filter}}".</p>
  </div>
  {% endif %} {% endfor %}
</div>
{% endblock %} {% block scripts %} {{ super() }}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const pollingStatusDiv = document.getElementById('polling-status');
    const ocidToPoll = ('{{ ocid_being_added }}' || '').trim();

    console.log(
      '[PollingScript] DOMContentLoaded fired. OCID to poll:',
      ocidToPoll
    );

    if (!pollingStatusDiv) {
      console.error(
        '[PollingScript] Critical: Polling status div with ID "polling-status" not found!'
      );
      return;
    }

    if (ocidToPoll) {
      let pollIntervalId = null;
      let pollCount = 0;
      const maxFastPolls = 20;
      const fastPollDelay = 3000;
      const slowPollDelay = 10000;
      const maxTotalPolls = maxFastPolls + 36;

      function updatePollingMessage(message, alertType = 'info') {
        if (pollingStatusDiv) {
          pollingStatusDiv.innerHTML = `<div class="alert alert-${alertType}" role="alert">${message}</div>`;
        }
      }

      function stopPolling() {
        if (pollIntervalId) {
          clearInterval(pollIntervalId);
          pollIntervalId = null;
          console.log('[PollingScript] Polling stopped.');
        }
      }

      function scheduleNextPollFetch() {
        stopPolling();

        pollCount++;
        let currentDelay =
          pollCount <= maxFastPolls ? fastPollDelay : slowPollDelay;

        if (pollCount > maxTotalPolls) {
          updatePollingMessage(
            `Обробка тендеру ${ocidToPoll} займає забагато часу. Будь ласка, перевірте пізніше або оновіть сторінку.`,
            'warning'
          );
          return;
        }

        const nextCheckTime = currentDelay / 1000;
        updatePollingMessage(
          `Обробка тендеру ${ocidToPoll} триває... Перевірка #${pollCount}. Наступна через ${nextCheckTime}с.`
        );

        pollIntervalId = setInterval(fetchTenderStatus, currentDelay);
      }

      function fetchTenderStatus() {
        stopPolling();
        console.log(
          `[PollingScript] Fetching status for ${ocidToPoll}, attempt ${
            pollCount + 1
          }`
        );

        fetch(`/check_tender_status/${ocidToPoll}`)
          .then((response) => {
            if (!response.ok) {
              return response.text().then((text) => {
                throw new Error(
                  `Network response was not ok: ${response.status} ${response.statusText}. Body: ${text}`
                );
              });
            }
            return response.json();
          })
          .then((data) => {
            if (data.exists && data.tender_uuid) {
              updatePollingMessage(
                `Тендер ${ocidToPoll} успішно додано! <a href="/tender/tenders/${data.tender_uuid}" class="alert-link">Переглянути деталі</a>.`,
                'success'
              );
            } else {
              scheduleNextPollFetch();
            }
          })
          .catch((error) => {
            console.error(
              '[PollingScript] Error polling for tender status:',
              error
            );
            updatePollingMessage(
              `Помилка при перевірці статусу тендеру ${ocidToPoll}. Деталі в консолі.`,
              'danger'
            );
          });
      }

      // Initial message and start the first fetch
      updatePollingMessage(
        `Перевіряємо статус додавання тендеру ${ocidToPoll}...`
      );
      fetchTenderStatus();
    } else {
      console.log(
        '[PollingScript] No OCID to poll (ocid_being_added was empty).'
      );
    }
  });
</script>
{% endblock %}
